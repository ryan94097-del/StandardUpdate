# ============================================================
# æ³•è¦æ¨™æº–ç›£æ¸¬ç³»çµ± - GitHub Actions å·¥ä½œæµç¨‹
# ============================================================
# åŠŸèƒ½ï¼š
# 1. æ¯æ—¥è‡ªå‹•åŸ·è¡Œçˆ¬èŸ² (UTC 00:00 = å°ç£ 08:00)
# 2. è‡ªå‹• Commit è®Šæ›´åˆ° Repository
# 3. Keepalive æ©Ÿåˆ¶é˜²æ­¢ GitHub æš«åœæ’ç¨‹
# ============================================================

name: Daily Standard Monitor

on:
  # å®šæ™‚åŸ·è¡Œ - æ¯æ—¥ UTC 00:00 (å°ç£æ™‚é–“ 08:00)
  schedule:
    - cron: '0 0 * * *'
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:

# æ¬Šé™è¨­å®š - å…è¨± Push
permissions:
  contents: write

jobs:
  # --------------------------------------------------------
  # ä¸»è¦ç›£æ¸¬ä»»å‹™
  # --------------------------------------------------------
  monitor:
    runs-on: ubuntu-latest
    
    steps:
      # æ­¥é©Ÿ 1: Checkout ç¨‹å¼ç¢¼
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # æ­¥é©Ÿ 2: è¨­å®š Python ç’°å¢ƒ
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      # æ­¥é©Ÿ 3: å®‰è£ä¾è³´
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # æ­¥é©Ÿ 4: åŸ·è¡Œçˆ¬èŸ²
      - name: Run Scraper
        env:
          EMAIL_HOST_USER: ${{ secrets.EMAIL_HOST_USER }}
          EMAIL_HOST_PASSWORD: ${{ secrets.EMAIL_HOST_PASSWORD }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          python scraper.py
      
      # æ­¥é©Ÿ 5: æª¢æŸ¥æ˜¯å¦æœ‰è®Šæ›´
      - name: Check for Changes
        id: git-check
        run: |
          git diff --exit-code history.json || echo "changes=true" >> $GITHUB_OUTPUT
      
      # æ­¥é©Ÿ 6: Commit ä¸¦ Push (åƒ…åœ¨æœ‰è®Šæ›´æ™‚)
      - name: Commit and Push Changes
        if: steps.git-check.outputs.changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add history.json
          git commit -m "ğŸ”„ Auto-update: $(date +'%Y-%m-%d %H:%M') UTC"
          git push

  # --------------------------------------------------------
  # Keepalive ä»»å‹™ - é˜²æ­¢ GitHub æš«åœæ’ç¨‹
  # --------------------------------------------------------
  keepalive:
    runs-on: ubuntu-latest
    # æ˜ç¢ºè¨­å®šå¯«å…¥æ¬Šé™
    permissions:
      contents: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          # ä½¿ç”¨ GITHUB_TOKEN ä»¥ç²å¾—å¯«å…¥æ¬Šé™
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # ä½¿ç”¨ keepalive-workflow ä¿æŒ Repository æ´»èº
      # å¦‚æœè¶…é 50 å¤©æ²’æœ‰æ´»å‹•ï¼Œæœƒè‡ªå‹•ç”¢ç”Ÿä¸€å€‹ Commit
      - name: Keepalive Workflow
        uses: gautamkrishnar/keepalive-workflow@v2
        with:
          # è¨­å®šå¤©æ•¸é–¾å€¼
          time_elapsed: 50
          # æ˜ç¢ºæŒ‡å®šä½¿ç”¨çš„ token
          gh_token: ${{ secrets.GITHUB_TOKEN }}
